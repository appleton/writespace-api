#!/usr/bin/env node

// Migrate all databases and associated security documents from src to dest.

const nano = require('nano');
const src  = 'https://USER:PASS@db.source.com/';
const dest = 'https://USER:PASS@db.destination.com/';

const srcDb = nano(src);
const destDb = nano(dest);

srcDb.db.list(function(err, res) {
  const dbs = res.filter((name) => name !== '_replicator');

  dbs.forEach(function(name) {
    console.log('replicating ' + name);

    destDb.db.replicate(src + name, name, {
      create_target: true,
      continuous: true
    }, function(err) {
      if (err) return console.log('error ', err);
      console.log('replicated ' + name);

      if (name === '_users') return;

      console.log('getting security doc for ' + name);
      srcDb.use(name).get('_security', function(err, res) {
        if (err) return console.log('error ', err);

        console.log('setting security doc for ' + name + ' to: ', res);

        destDb.use(name).insert(res, '_security', function(err) {
          if (err) return console.log('error ', err);
          console.log('set security doc for ' + name);
        });
      });
    });
  });
});
